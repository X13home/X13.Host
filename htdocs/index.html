<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>X13.Home</title>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
</head>
<body>

  <div class="ui-grid-b ui-responsive">
    <div class="ui-block-a ui-bar-c" style="height: 150px;">
      <h3 style="text-align: center">Dimable lighting</h3>
      <input type="range" min="0" max="100" data-highlight="true" data-pub="/var/demo/lightSet" data-sub="/var/demo/light" />
      <button data-pub="/var/demo/pir1">PIR1</button>
    </div>
    <div class="ui-block-b ui-bar-d" style="height: 150px;">
      <h3 style="text-align: center">On/Off lamp</h3>
      <select data-role="slider" data-pub="/var/demo/lampSet" data-sub="/var/demo/lamp">
        <option value="0">Off</option>
        <option value="1">On</option>
      </select>
    </div>
    <div class="ui-block-c ui-bar-c" style="height: 150px;">
      <span>Temperature <label data-sub="/var/demo/OutTa"></label> °C</span>
    </div>
  </div>


  <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
  <script type="text/javascript" src="pubsub.js"></script>
  <script type="text/javascript">
    var timer;

    function reconnect() {
      clearTimeout(timer);
      timer = setTimeout(function () { startStreaming(); }, 30);
    }

    function dispatchFunc(topic, v) {
      $("input[type='number'][data-sub='" + topic + "']").each(function (idx, el) {
        $(el).val(v);
        $(el).slider("refresh");
      });
      $("select[data-role='slider'][data-sub='" + topic + "']").each(function (idx, el) {
        el.selectedIndex = v;
        $(el).slider("refresh");
      });
      $("label[data-sub='" + topic + "']").text(v);
    }

    function startStreaming() {
      pubsub.register({ data: dispatchFunc, error: reconnect });
      $("input[type='number'][data-sub]").each(function (idx, el) {
        pubsub.subscribe(el.dataset.sub, { success: pubsub.read });
        $.getJSON("/data" + el.dataset.sub, function (v) {
          $(el).val(v);
          $(el).slider("refresh");
        });
      });
      $("select[data-role='slider'][data-sub]").each(function (idx, el) {
        pubsub.subscribe(el.dataset.sub, { success: pubsub.read });
        $.getJSON("/data" + el.dataset.sub, function (v) {
          el.selectedIndex = v;
          $(el).slider("refresh");
        });
      });
      $("label[data-sub]").each(function (idx, el) {
        pubsub.subscribe(el.dataset.sub, { success: pubsub.read });
        $.getJSON("/data" + el.dataset.sub, function (v) {
          el.innerHTML = v;
        });
      });

    }

    $(function () {

      $("input[type='number'][data-pub]").each(function (idx, el) {
        $(el).slider({
          stop: function (event, ui) {
            pubsub.publish(event.target.dataset.pub, event.target.value);
          }
        });
        $.getJSON("/data" + el.dataset.pub, function (v) {
          $(el).val(v);
          $(el).slider("refresh");
        });
      });
      $("input[type='number']:not([data-pub])").slider("disable");

      $("select[data-role='slider'][data-pub]").each(function (idx, el) {
        $(el).slider({
          stop: function (event, ui) {
            pubsub.publish(event.target.dataset.pub, event.target.selectedIndex);
          }
        });
        $.getJSON("/data" + el.dataset.pub, function (v) {
          el.selectedIndex = v;
          $(el).slider("refresh");
        });
      });
      $("select[data-role='slider']:not([data-pub])").slider("disable");

      $("button[data-pub]").each(function (idx, el) {
        $(el).mousedown(function (obj) {
          pubsub.publish(obj.target.dataset.pub, true);
        });
        $(el).mouseup(function (obj) {
          pubsub.publish(obj.target.dataset.pub, false);
        });
      });

      startStreaming();
    });
  </script>
</body>
</html>
